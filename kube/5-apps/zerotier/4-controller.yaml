apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zerotier-controller
    namespace: zerotier
spec:
    interval: 15m
    chart:
        spec:
            chart: app-template
            version: 1.2.1
            sourceRef:
                kind: HelmRepository
                name: bjw-s
                namespace: flux-system
    maxHistory: 3
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        controller:
            type: statefulset
            strategy: RollingUpdate
        fullNameOverride: zerotier-controller
        image:
            repository: docker.io/zyclonite/zerotier
            tag: 1.10.2
        env:
            ZT_OVERRIDE_LOCAL_CONF: "true"
            ZT_ALLOW_MANAGEMENT_FROM: ENC[AES256_GCM,data:Y3WY3mJt+WBx,iv:WuI7PsNU8WfSfAPfExYNt0VC/sQy00QOC9QCdQZRABs=,tag:dmA4vyDFGnDqxF8nGOtKig==,type:str]
        # dnsPolicy: None
        dnsConfig:
            options:
                - name: ndots
                  value: "1"
        #     nameservers:
        #         - fake.ip
        service:
            main:
                enabled: true
                primary: true
                type: LoadBalancer
                externalTrafficPolicy: Local
                externalIPs:
                    - ENC[AES256_GCM,data:I5YluqNB+7Rjxd0=,iv:BUQx8lJLdmHNeXjot9L30Xczlrjm850NLRX7wplB8Xc=,tag:CF6PITU9sVzVhhuVwQszdA==,type:str]
                ports:
                    http:
                        enabled: false
                    zerotier-udp:
                        enabled: true
                        primary: true
                        protocol: UDP
                        port: 9993
                        targetPort: 9993
                    zerotier-tcp:
                        enabled: true
                        primary: true
                        protocol: TCP
                        port: 9993
                        targetPort: 9993
        persistence:
            zerotier-one:
                enabled: true
                type: pvc
                mountPath: /var/lib/zerotier-one
                retain: true
                existingClaim: zerotier-one
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1xl3fcwdw56k73lraxsjhde4ygwn7jw0js5l5qw7vsp54vc5czuwstcejxu
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSArQWRpeGtDMHMwTFZmMUtE
            Wit2MmZybTljZVduWlZCL2I1b0xVTlM0dnlrClN1cGdhdnh0eHY1VjU1Z1E5T3hS
            Q01rUk8rWEV1eVhZMXAyaWd1VElFVGMKLS0tIDhKV3kveDlhZUUyWlVyazdJRUJy
            b0srZm85a3A5dnl2MVNtU0x2elQrMTAKUnaLiLE0CFSUxY0H3svHc/QBbhNfO5Kr
            Pv15Igi9cfRh7Nl5vfaz98OntlLJHd+2N3MkGg7MazK5Z5vfia87Zw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-02-09T02:08:21Z"
    mac: ENC[AES256_GCM,data:bQNC+4G6HuvUgaQ3X05hrGN+xoSRZuXdIMaBNGY/TRNUShZuqnKpr/70bkHsZJLGPEvJs3wjdbEb9TY4y7iaoZJXmyCqyrLllocoZTnVbxi6KGIFFWQRR5NfPUq0GjpTnXa5V65xCjWi9BYknbq6JupjQq8WLjBBXcY3ljtCuRE=,iv:Dki2gI7tdmmLzmoswGIdon962aNqM9u4JqxiZdW1S4c=,tag:3WzZgcE781gSCXHuPls7tQ==,type:str]
    pgp:
        - created_at: "2023-02-08T19:41:37Z"
          enc: |
            -----BEGIN PGP MESSAGE-----

            hF4DAAAAAAAAAAASAQdAzi4jPGLekTbdMxNBKWkZradk+AxkKVTCy1m7bka6XjAw
            CLdImQuEN/+TyNbyuVp4rXFibyMilk0JL0RD1BMPEaN+3Nah6lLnbJd6UDTI8ADj
            0l4BdNRh49/Fuvl26gPkFV1LfLudJgkyqdIokG0T+Pk7xut3d3EYU6/050j82R0x
            B55QgViRG+l/XBAmYGKQKPhs0DL6JyKG/LkaLBIdxkKFYUWSYkL2tTomaU5zbWEW
            =enm6
            -----END PGP MESSAGE-----
          fp: 31E70E5BC80C58AFF5DD649921AC5A1AC6E5B7F2
    encrypted_regex: ^(hosts|host|ZU_DEFAULT_USERNAME|ZU_DEFAULT_PASSWORD|ZU_CONTROLLER_ENDPOINT|nameservers|secretName|commonName|dnsNames|externalIPs|ZT_ALLOW_MANAGEMENT_FROM)$
    version: 3.7.3
