apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: zerotier-controller
    namespace: zerotier
spec:
    interval: 15m
    chart:
        spec:
            chart: app-template
            version: 1.2.1
            sourceRef:
                kind: HelmRepository
                name: bjw-s
                namespace: flux-system
    maxHistory: 3
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        controller:
            type: statefulset
            strategy: RollingUpdate
        fullNameOverride: zerotier-controller
        image:
            repository: docker.io/zyclonite/zerotier
            tag: 1.10.2
        env:
            ZT_OVERRIDE_LOCAL_CONF: "true"
            ZT_ALLOW_MANAGEMENT_FROM: ENC[AES256_GCM,data:VH9ehVW2Gsx0,iv:cGaRGaaiCfiu1eab2nOZlTF+nMrzDZfmDQlKaQpr40Q=,tag:M9bdtwAXDmq2X04q9lH5Uw==,type:str]
        # dnsPolicy: None
        dnsConfig:
            options:
                - name: ndots
                  value: "1"
        #     nameservers:
        #         - fake.ip
        hostNetwork: true
        service:
            main:
                enabled: true
                type: NodePort
                ports:
                    http:
                        enabled: false
                    zerotier-udp:
                        enabled: true
                        protocol: UDP
                        port: 9993
                        targetPort: 9993
                        nodePort: 30001
                    zerotier-tcp:
                        enabled: true
                        protocol: TCP
                        port: 9993
                        targetPort: 9993
                        nodePort: 30001
        persistence:
            zerotier-one:
                enabled: true
                type: pvc
                mountPath: /var/lib/zerotier-one
                retain: true
                existingClaim: zerotier-one
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1xl3fcwdw56k73lraxsjhde4ygwn7jw0js5l5qw7vsp54vc5czuwstcejxu
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB4WnhlQXBxdnFDeTdBTytu
            cy9PemM4Q3R4R1Z0NkZGa1l6RFNpdG84dkVNCktocVMrcEtkRUtteHlRbmFYcDhE
            d29KMklMQmRXN05NWVZvQ3MzcUtQd28KLS0tIDd2NWNPay9OdUY2M3crQjR0L0dj
            UkM0WGxFNVlsQ2J6ZEkwaE0zK3FybTQKgfMnTou0TApYFiECmXVg7PVOQst2m6B1
            4tvRYJL7lOztp+Cs4hWqMxrBnWtYTxRkuiGTAW5MK3Zmu4I2A2wDmQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-02-09T09:31:05Z"
    mac: ENC[AES256_GCM,data:bsAX7FUlIvZ7FoqrrrR163DqbCdSC++qHbJCRGb0bQUe/1HGrR8iOVNnllsVMCj3Goh4xT0IrtQpwUmlPVNkWuWfnhHqDB9abVkNhlVAcwSl6fnbDdtEkglWauQLaGj+SKK4w7RABDBiAWbttFDUl9YdQz8bmup7o4Rh/xjpiu4=,iv:Ek1Q1tufED/iiWtBSbbdGahrthDGxCGavruVkB9kdNM=,tag:Sz5CZkm8yKRxdLRKUGXLsA==,type:str]
    pgp:
        - created_at: "2023-02-09T03:25:06Z"
          enc: |
            -----BEGIN PGP MESSAGE-----

            hF4DAAAAAAAAAAASAQdAHyfug5pftJG3pIFJjTtawQpD3r9oszgqgQj+nlMlr0Yw
            bch6ktVJjrJ0w9or7wwgz0ssPYXy076/HF9C2qu3LAyoVBLSAF3QscZXvgFG8pua
            0l4B7kXiw8Mnf6KdtjRaEJ9bbJA3dXxwpdlRA0Mi+9EpOfidsrjRvfsdzNmAV4lq
            OvRpr+6Q/KV0fOrhT+snxymFaoOtaclq1ZZLpEGCaH+b5R+oeJ2SiqOB437k+zLE
            =5/3C
            -----END PGP MESSAGE-----
          fp: 31E70E5BC80C58AFF5DD649921AC5A1AC6E5B7F2
    encrypted_regex: ^(hosts|host|ZU_DEFAULT_USERNAME|ZU_DEFAULT_PASSWORD|ZU_CONTROLLER_ENDPOINT|nameservers|secretName|commonName|dnsNames|loadBalancerIP|externalIPs|ZT_ALLOW_MANAGEMENT_FROM)$
    version: 3.7.3
