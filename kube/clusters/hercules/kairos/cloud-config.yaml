#cloud-config
hostname: "hercules"
users:
  - name: "jj"
    #passwd: "" # password hash or plaintext password
    lock_passwd: true
    groups: ["admin"]
    shell: "/bin/bash"
    ssh_authorized_keys:
      - "github:JJGadgets"
      - "github:jjgadgets"
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPkuFpjTwHzP1cw9XDtJOKKROwkZycvAx++w1j/7g2Yr"
install:
  image: &img "quay.io/kairos/debian:bookworm-standard-amd64-generic-v2.4.2-k3sv1.28.2-k3s1"
  auto: true # for single node without P2P/VPN
  #device: "/dev/sda"
  reboot: true
  poweroff: false
  firmware: "bios"
  part-table: "gpt"
  system.size: 2048
  passive.size: 2048
  recovery-system.size: 3072
  partitions:
    oem:
      size: 60
      fs: "ext4"
  bind_mounts:
    - /etc/wireguard
reset:
  reboot: true
  poweroff: false
  reset-persistent: false
upgrade:
  reboot: true
  poweroff: false
kubevip:
  enable: false
k3s:
  enabled: true
  replace_args: true
  args: ["--disable=flannel,traefik,servicelb,local-storage,metrics-server", "--flannel-backend=none", "--disable-network-policy", "--service-cidr 172.24.0.0/16", "--cluster-cidr 172.23.0.0/16", "--disable-cloud-controller", "--disable-kube-proxy", "--write-kubeconfig-mode 0644"]
stages:
  after-install-chroot: &apt
    - name: Install extra packages
      commands:
        - apt update
        - apt install -y wireguard-tools
  after-upgrade-chroot: *apt
  boot:
    - name: "1. Load WireGuard kernel module"
      modules: ["wireguard"]
    - name: "2. Create WireGuard config folder"
      directories:
        - path: "/etc/wireguard"
          permissions: 0700
          owner: 0
          group: 0
    - name: "3. Install WireGuard config"
      files:
        - path: "/etc/wireguard/wg0.conf"
          permissions: 0700
          owner: 0
          group: 0
          content: |
            [Interface]
            PrivateKey = ${SECRET_HERCULES_WG_PRIVKEY}
            Address = ${SECRET_HERCULES_WG_ADDRESS}
            DNS = ${SECRET_HERCULES_WG_DNS}
            ListenPort = ${SECRET_HERCULES_WG_LISTEN}
            MTU = 1420
            [Peer]
            PublicKey = ${SECRET_HERCULES_WG_PEERKEY}
            PresharedKey = ${SECRET_HERCULES_WG_PEERPSK}
            AllowedIPs = ${SECRET_HERCULES_WG_ALLOWEDIPS}
            PersistentKeepalive = 15
    - name: "4. Enable wg0.conf"
      systemctl:
         enable: ["wg-quick@wg0.service"]
