---
kubeApiServer:
  enabled: true
  endpoints: &cp ["${IP_ROUTER_VLAN_K8S_PREFIX}1", "${IP_ROUTER_VLAN_K8S_PREFIX}2", "${IP_ROUTER_VLAN_K8S_PREFIX}3"]
  serviceMonitor:
    metricRelabelings:
      # Drop high cardinality labels
      - &dropDuration
        action: drop
        sourceLabels: ["__name__"]
        regex: (apiserver|etcd|rest_client)_request(|_sli|_slo)_duration_seconds_bucket
      - action: drop
        sourceLabels: ["__name__"]
        regex: (apiserver_response_sizes_bucket|apiserver_watch_events_sizes_bucket|apiserver_request_body_size_bytes_bucket)
kubeScheduler:
  enabled: true
  endpoints: *cp
kubeControllerManager:
  enabled: true
  endpoints: *cp
kubeEtcd:
  enabled: true
  endpoints: *cp
  serviceMonitor:
    metricRelabelings:
      - *dropDuration
  # service: # TODO: did I add this in by accident?
  #   enabled: true
  #   port: 2381
  #   targetPort: 2381
kubelet:
  enabled: true
  serviceMonitor:
    #interval: "10s"
    #scrapeTimeout: "5s"
    attachMetadata:
      node: true
    metricRelabelings:
      # replaces other node identifiers with hostname
      - sourceLabels: ["node"]
        targetLabel: instance
        action: replace
      # Drop high cardinality labels
      - action: labeldrop
        regex: (uid)
      - action: labeldrop
        regex: (id|name)
      - action: drop
        sourceLabels: ["__name__"]
        regex: (rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count|apiserver_request_body_size_bytes_bucket)
      - *dropDuration
kubeProxy:
  enabled: false # Disabled due to eBPF
