---
# yaml-language-server: $schema=https://crds.jank.ing/operator.victoriametrics.com/vmcluster_v1beta1.json
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMCluster
metadata:
  name: victoria
  namespace: monitoring
spec:
  retentionPeriod: "6" # months if no unit specified
  replicationFactor: 3
  # extraArgs:
  #   dedup.minScrapeInterval: 1m
  # storage:
  #   storageClassName: block
  #   accessModes: [ReadWriteOnce]
  #   volumeMode: Filesystem
  #   resources:
  #     requests:
  #       storage: 100Gi
  #   dataSourceRef:
  #     apiGroup: volsync.backube
  #     kind: ReplicationDestination
  #     name: victoria-vmsingle-bootstrap
  # resources: # TODO: refine
  #   requests:
  #     cpu: 500m
  #     memory: 1Gi
  #   limits:
  #     cpu: 1
  #     memory: 4Gi
  vmstorage:
    replicaCount: 3
    extraArgs:
      dedup.minScrapeInterval: 1m
    storageDataPath: /vm-data
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: local
          resources:
            requests:
              storage: 10Gi
    resources:
      requests:
        cpu: 300m
        memory: 1Gi
      limits:
        cpu: 1
        memory: 4Gi
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vmstorage
            app.kubernetes.io/instance: victoria
  vmselect:
    replicaCount: 3
    extraArgs:
      dedup.minScrapeInterval: 1m
      search.minStalenessInterval: 5m
      vmalert.proxyURL: http://vmalert-victoria.svc.cluster.local:8080
    cacheMountPath: /select-cache
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: local
          resources:
            requests:
              storage: 2Gi
    resources:
      requests:
        cpu: 300m
        memory: 1Gi
      limits:
        cpu: 1
        memory: 4Gi
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vmselect
            app.kubernetes.io/instance: victoria
  vminsert:
    replicaCount: 2
    resources:
      requests:
        cpu: 300m
        memory: 1Gi
      limits:
        cpu: 1
        memory: 4Gi
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vminsert
            app.kubernetes.io/instance: victoria
