---
# yaml-language-server: $schema=https://github.com/JustinGrote/FluentBitJsonSchema/releases/latest/download/fluentbit.schema.json
service:
  daemon: off
  log_level: warn
  http_server: "on"
  http_listen: "[::]"
  http_port: 8080
pipeline:
  inputs:
    - name: tail # https://docs.fluentbit.io/manual/pipeline/inputs/tail
      alias: kubernetes
      path: /var/log/containers/*.log
      exclude_path: /var/log/*fluent* # comma separated
      multiline.parser: cri
      tag: kubernetes.*
    - name: syslog
      alias: fortigate
      mode: tcp
      port: 51401
      parser: syslog-rfc5424
      tls: "on"
      tls.cert_file: /tls/tls.crt
      tls.key_file: /tls/tls.key
      tag: fortigate.*
  filters:
    # enrich and process logs with k8s metadata
    - name: kubernetes # https://docs.fluentbit.io/manual/pipeline/filters/kubernetes
      alias: kubernetes
      match: kubernetes.*
      kube_tag_prefix: kubernetes.var.log.containers.
      buffer_size: "0"
      merge_log: "on"
      keep_log: "off"
      "k8s-logging.parser": "on"
      "k8s-logging.exclude": "on"
      namespace_labels: "on"
      annotations: "off" # too big and mostly irrelevant, as it contains stuff like Reloader and Multus
      namespace_annotations: "off"
      owner_references: "off" # ended up not being that helpful
      # use_kubelet: "on" # wanna use it but can't verify TLS without rotate-server-certificates :(
      # kubelet_host: "$${KUBE_NODE_IP}"
      # kube_ca_path: "/run/secrets/kubernetes.io/serviceaccount" # both apiserver SA CA and localhost kubelet CA are mounted here
    #   tls.verify: "off"
    # - name: stdout
    #   match: kubernetes.*
    # Lift out the kubernetes labels so we can rename them
    - name: nest
      match: "*"
      wildcard: "pod_name"
      operation: lift
      nested_under: kubernetes
      add_prefix: kubernetes_
    - name: nest
      match: kubernetes.*
      operation: lift
      nested_under: kubernetes
      add_prefix: kubernetes_
    - name: modify
      match: kubernetes.*
      remove_wildcard:
        - kubernetes_annotations
        - kubernetes_docker_id
    - name: parser
      match: fortigate.*
      key_name: message
      parser: logfmt
      reserve_data: true
      preserve_key: true
  outputs:
      # Victoria Logs
    - name: victoria-logs-kubernetes
      match: 'kubernetes.*'
      host: victoria-logs-victoria-logs-single-server.monitoring.svc.cluster.local
      port: 9428
      uri: >-
        /insert/jsonline?_stream_fields=stream,source,kubernetes_namespace_name,kubernetes_pod_name,kubernetes_container_name,kubernetes_host,kubernetes_pod_ip&ignore_fields=kubernetes_annotations*&_msg_field=log&_time_field=date
      compress: gzip
      format: json_lines
      json_date_format: iso8601
      header:
        - 'AccountID 0'
        - 'ProjectID 0'
      log_response_payload: "off"
    - name: victoria-logs-fortigate
      match: 'fortigate.*'
      host: victoria-logs-victoria-logs-single-server.monitoring.svc.cluster.local
      port: 9428
      uri: >-
        /insert/jsonline?_stream_fields=host,type,subtype,vd&_msg_field=message&_time_field=date
      compress: gzip
      format: json_lines
      json_date_format: iso8601
      header:
        - 'AccountID 51401'
        - 'ProjectID 0'
      log_response_payload: "off"
    # # stdout
    # - name: stdout
    #   match: '*'
    #   format: json_lines
    #   json_date_format: iso8601
