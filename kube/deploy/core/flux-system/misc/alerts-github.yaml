---
# yaml-language-server: $schema=https://crds.jank.ing/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name "${CLUSTER_NAME}-alerts-github"
  namespace: flux-system
spec:
  refreshInterval: 1m
  secretStoreRef:
    kind: ClusterSecretStore
    name: 1p
  dataFrom:
    - extract:
        key: "Flux Alerts - ${CLUSTER_NAME}"
  target:
    creationPolicy: Owner
    deletionPolicy: Retain
    name: *name
    template:
      type: Opaque
      data:
        token: '{{ .SECRET_FLUX_ALERTS_GITHUB }}'
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Provider
metadata:
  name: &name "${CLUSTER_NAME}-alerts-github"
  namespace: flux-system
spec:
  type: github
  address: https://github.com/JJGadgets/Biohazard
  secretRef:
    name: *name
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Alert
metadata:
  name: &name "${CLUSTER_NAME}-alerts-github"
  namespace: flux-system
spec:
  providerRef:
    name: *name
  eventMetadata:
    cluster: "${CLUSTER_NAME}"
  eventSeverity: info
  eventSources:
    - kind: Kustomization
      name: "*"
      namespace: flux-system
