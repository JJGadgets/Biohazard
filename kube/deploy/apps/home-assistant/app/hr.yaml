---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-4.6.2/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app home-assistant
  namespace: *app
spec:
  interval: 5m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: *app
  values:
    controllers:
      app:
        type: deployment
        replicas: 1
        pod:
          hostname: "home-assistant"
          labels:
            ingress.home.arpa/envoy-internal: allow
            egress.home.arpa/iot: allow
            egress.home.arpa/esp: allow
            egress.home.arpa/appletv: allow
            egress.home.arpa/r2: allow
            egress.home.arpa/pypi: allow # entrypoint does a `uv pip install uv` in the venv
            egress.home.arpa/github: allow # TODO: try to harden this eventually, maybe HACS as ImageVolume?
            authentik.home.arpa/oidc: allow
            db.home.arpa/mqtt: allow
            prom.home.arpa/kps: allow
            dns.home.arpa/l7: "true"
          annotations:
            # generate reproducible "locally assigned" (aka non-vendor-assigned) MAC address from a FQDN (e.g. for Home Assistant Multus)
            # `echo "$FQDN" | md5sum | sed 's/^\(..\)\(..\)\(..\)\(..\)\(..\).*$/02:\1:\2:\3:\4:\5/'`
            # source: https://serverfault.com/questions/299556/how-to-generate-a-random-mac-address-from-the-linux-command-line/299563#299563
            k8s.v1.cni.cncf.io/networks: |
              [{
                "name":"iot",
                "namespace": "multus",
                "ips": ["${APP_IP_HOME_ASSISTANT_IOT}"],
                "mac": "${APP_MAC_HOME_ASSISTANT_IOT}",
                "gateway": "${IP_ROUTER_VLAN_IOT}"
              }]
          resources:
            requests:
              cpu: 30m
            limits:
              cpu: 1
              memory: 1Gi
        containers:
          app:
            image: &img
              repository: ghcr.io/home-operations/home-assistant
              tag: 2026.1.2@sha256:9587276dcc680f8210115015508cd02d19f6921cdbff6bf119453fc4a8e10969
            env: &env
              TZ: "${CONFIG_TZ}"
            # envFrom: &envFrom
            #   - secretRef:
            #       name: home-assistant-secrets
            securityContext: &sc
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
    service:
      app:
        primary: true
        controller: app
        forceRename: *app
        ports:
          http:
            port: 80
            targetPort: 8123
            protocol: HTTP
            appProtocol: http
            primary: true
          hass:
            port: 8123
            protocol: HTTP
            appProtocol: http
      expose:
        primary: false
        controller: app
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: "${APP_IP_HOME_ASSISTANT:=127.0.0.1}"
        ports:
          homekit:
            port: 21061
            protocol: TCP
            primary: false
          homekit-denon:
            port: 21062
            protocol: TCP
            primary: false
          homekit-sensors:
            port: 21063
            protocol: TCP
            primary: false
          homekit-4:
            port: 21064
            protocol: TCP
            primary: false
          homekit-5:
            port: 21065
            protocol: TCP
            primary: false
          homekit-6:
            port: 21066
            protocol: TCP
            primary: false
    route:
      app:
        hostnames: ["${APP_DNS_HOME_ASSISTANT:=home-assistant}"]
        parentRefs:
          - name: envoy-internal
            namespace: ingress
            sectionName: internal
        rules:
          - backendRefs:
              - identifier: app
                port: 80
    persistence:
      data:
        existingClaim: home-assistant-data
        advancedMounts:
          app:
            app:
              - subPath: config
                path: /config
      tmp:
        type: emptyDir
        medium: Memory
        sizeLimit: 50Mi
        globalMounts:
          - subPath: tmp
            path: /tmp
          - subPath: logs
            path: /config/logs
    defaultPodOptions:
      automountServiceAccountToken: false
      enableServiceLinks: false
      runtimeClassName: kata
      securityContext:
        runAsNonRoot: true
        runAsUser: &uid 65534 # image needs this for uv workaround perms
        runAsGroup: &gid 65533
        fsGroup: *gid
        fsGroupChangePolicy: Always
        seccompProfile: { type: "RuntimeDefault" }
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: "fuckoff.home.arpa/{{ .Release.Name }}"
                    operator: DoesNotExist
      hostAliases:
        - ip: "${APP_IP_AUTHENTIK:=127.0.0.1}"
          hostnames: ["${APP_DNS_AUTHENTIK:=authentik}"]
      dnsConfig:
        options:
          - name: ndots
            value: "1"
    serviceMonitor:
      app:
        service:
          identifier: app
        endpoints:
          - port: http
            scheme: http
            path: /api/prometheus
    # networkpolicies:
    #   app:
    #     controller: app
    #     policyTypes: [Ingress, Egress]
    #     rules:
    #       ingress:
    #         - from:
    #             - podSelector:
    #                 matchLabels:
    #                   app.kubernetes.io/name: home-assistant
    #               namespaceSelector:
    #                 matchLabels:
    #                   kubernetes.io/metadata.name: home-assistant
    #           ports:
    #             - port: *port
