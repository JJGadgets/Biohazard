---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/gateway.envoyproxy.io/envoyextensionpolicy_v1alpha1.json
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: radicale-ios-dav
  namespace: radicale
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: radicale-app
  lua:
    - type: Inline
      inline: |
        function envoy_on_request(request_handle)
          if not request_handle:headers():get("authorization") then
            request_handle:streamInfo():dynamicMetadata():set("envoy.filters.http.lua", "authorization", "n")
          else
            request_handle:streamInfo():dynamicMetadata():set("envoy.filters.http.lua", "authorization", "y")
          end
        end
        function envoy_on_response(response_handle)
          if not response_handle:streamInfo():dynamicMetadata():get("envoy.filters.http.lua") or response_handle:streamInfo():dynamicMetadata():get("envoy.filters.http.lua")["authorization"] == "n" then
            response_handle:headers():replace("www-authenticate", "Basic realm=\"fuck off\"")
            response_handle:headers():replace(":status", "401")
            response_handle:headers():remove("location")
          end
        end
