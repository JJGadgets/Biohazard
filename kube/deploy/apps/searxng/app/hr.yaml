---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: &app searxng
  namespace: *app
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: "2.6.0"
      sourceRef:
        name: bjw-s
        kind: HelmRepository
        namespace: flux-system
  values:
    controllers:
      main:
        type: deployment
        replicas: 1
        pod:
          labels:
            ingress.home.arpa/nginx-internal: "allow"
            egress.home.arpa/mullvad: "allow"
            egress.home.arpa/internet-https: "allow"
        containers:
          main:
            image: &img
              repository: "docker.io/searxng/searxng"
              tag: "latest@sha256:a46962557dce9ad029ef36b6717304c51803d73a8043b4a513b09204df6bc91c"
            command: ["uwsgi", "--master", "--http-socket", "0.0.0.0:8080", "/usr/local/searxng/dockerfiles/uwsgi.ini"]
            env:
              TZ: "${CONFIG_TZ}"
              SEARXNG_BASE_URL: "https://{APP_DNS_SEARXNG}/"
              SEARXNG_URL: "https://{APP_DNS_SEARXNG}"
              SEARXNG_PORT: &http "8080"
              SEARXNG_REDIS_URL: "unix:///etc/searxng/redis.sock?db=0"
            envFrom:
              - secretRef:
                  name: "searxng-secrets"
            securityContext: &sc
              readOnlyRootFilesystem: true
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
            resources:
              requests:
                cpu: "50m"
                memory: "1Gi"
              limits:
                cpu: "3000m"
                memory: "2Gi"
          redis:
            image:
              repository: "public.ecr.aws/docker/library/redis"
              tag: "7.2.4-bookworm@sha256:8482ee910acbcd8f31c5a08329e3903dbd2a018e2837897bfaf9bafb80b494b2"
            command: ["redis-server", "--save", "''", "--appendonly", "no", "--port", "0", "--bind", "127.0.0.1", "--unixsocket", "/etc/searxng/redis.sock", "--unixsocketperm", "700"] # save and appendonly options forcibly disable RDB and AOF persistence entirely
            securityContext: *sc
            resources:
              requests:
                cpu: "10m"
                memory: "32Mi"
              limits:
                cpu: "1000m"
                memory: "512Mi"
    service:
      main:
        ports:
          http:
            port: *http
    ingress:
      main:
        enabled: true
        primary: true
        className: "nginx-internal"
        hosts:
          - host: &host "${APP_DNS_SEARXNG}"
            paths: &paths
              - path: /
                pathType: Prefix
                service:
                  name: main
                  port: http
        tls:
          - hosts: [*host]
    dnsConfig:
      options:
        - name: ndots
          value: "1"
    persistence:
      config:
        enabled: true
        type: configMap
        name: "searxng-config"
        advancedMounts:
          main:
            main:
              - subPath: "settings.yml"
                path: "/etc/searxng/settings.yml"
                readOnly: true
      tmp:
        enabled: true
        type: emptyDir
        medium: Memory
        globalMounts:
          - subPath: "etc"
            path: "/etc/searxng"
            readOnly: false
    configMaps:
      config:
        enabled: true
        data:
          server.toml: |-
            use_default_settings:
              engines:
                keep_only:
                  - arch linux wiki
                  - google
                  - google images
                  - google news
                  - google videos
                  - google scholar
                  - google play apps
                  - duckduckgo
                  - brave
                  - startpage
                  - gitlab
                  - github
                  - codeberg
                  - sourcehut
                  - bitbucket
                  - apple app store
                  - wikipedia
                  - currency
                  - docker hub
                  - ddg definitions
                  - duckduckgo images
                  - bandcamp
                  - deviantart
                  - tineye
                  - apple maps
                  - fdroid
                  - flickr
                  - free software directory
                  - z-library
                  - lobste.rs
                  - azlyrics
                  - openstreetmap
                  - npm
                  - pypi
                  - lib.rs
                  - nyaa
                  - reddit
                  - sepiasearch
                  - soundcloud
                  - stackoverflow
                  - askubuntu
                  - superuser
                  - searchcode code
                  - unsplash
                  - youtube
                  - wolframalpha
                  - mojeek
            engines:
              - name: brave
                disabled: false
              - name: startpage
                disabled: false
              - name: apple app store
                disabled: false
              - name: ddg definitions
                disabled: false
              - name: tineye
                disabled: false
              - name: apple maps
                disabled: false
              - name: duckduckgo images
                disabled: false
              - name: fdroid
                disabled: false
              - name: free software directory
                disabled: false
              - name: bitbucket
                disabled: false
              - name: gitlab
                disabled: false
              - name: codeberg
                disabled: false
              - name: google play apps
                disabled: false
              - name: lobste.rs
                disabled: false
              - name: azlyrics
                disabled: false
              - name: npm
                disabled: false
              - name: nyaa
                disabled: false
                categories: videos
              - name: searchcode code
                disabled: false
              - name: mojeek
                disabled: false
              - name: lib.rs
                disabled: false
              - name: sourcehut
                disabled: false
            general:
              instance_name: "JJGadgets Search"
              enable_metrics: false
            brand:
              new_issue_url: ""
              docs_url: ""
              public_instances: ""
              wiki_url: ""
              issue_url: ""
            search:
              safe_search: 0
              default_lang: "en"
              max_page: 0
            server:
              base_url: "https://${APP_DNS_SEARXNG}/"
              image_proxy: true
              http_protocol_version: "1.1"
              method: "GET"
            outgoing:
              proxies:
                all://:
                  - socks5://10.64.0.1:1080
                  - socks5://10.8.0.1:1080
            ui:
              static_use_hash: true
              infinite_scroll: true
              default_theme: "simple"
              theme_args:
                simple_style: "dark"
            enabled_plugins:
              - 'Hash plugin'
              - 'Search on category select'
              - 'Self Information'
              - 'Tracker URL remover'
              - 'Open Access DOI rewrite'
              - 'Vim-like hotkeys'
              - 'Hostname replace'
            hostname_replace:
              '(.*\.)?youtube\.com$': '${APP_DNS_PIPED_FRONTEND}'
              '(.*\.)?youtu\.be$': '${APP_DNS_PIPED_FRONTEND}'
              '(.*\.)?reddit\.com$': '${APP_DNS_LIBREDDIT}'
              '(.*\.)?redd\.it$': '${APP_DNS_LIBREDDIT}'
    # NOTE: Search engines disabled:
    # - archive.is (too many requests)
    defaultPodOptions:
      automountServiceAccountToken: false
      enableServiceLinks: false
      securityContext:
        runAsNonRoot: true
        runAsUser: &uid ${APP_UID_SEARXNG}
        runAsGroup: *uid
        fsGroup: *uid
        fsGroupChangePolicy: "Always"
        seccompProfile: { type: "RuntimeDefault" }
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: "kubernetes.io/hostname"
          whenUnsatisfiable: "DoNotSchedule"
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: *app
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: "fuckoff.home.arpa/searxng"
                    operator: "DoesNotExist"
