apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: aws-lb
    namespace: kube-system
    annotations:
        meta.helm.sh/release-name: aws-lb
        meta.helm.sh/release-namespace: kube-system
    labels:
        app.kubernetes.io/managed-by: Helm
spec:
    interval: 5m
    chart:
        spec:
            chart: aws-load-balancer-controller
            version: 1.4.7
            sourceRef:
                kind: HelmRepository
                name: aws-eks
                namespace: flux-system
            interval: 5m
    install:
        # perform remediation when helm install fails
        remediation:
            retries: 100
    upgrade:
        # perform remediation when helm upgrade fails
        remediation:
            retries: 100
            # remediate the last failure, when no retries remain
            remediateLastFailure: true
        cleanupOnFail: true
    values:
        # hostNetwork used because Cilium is main CNI
        hostNetwork: true
        dnsPolicy: ClusterFirstWithHostNet
        # auto create authz resources
        serviceAccount:
            create: true
        rbac:
            create: true
        # select cluster and nodes
        clusterName: Biohazard
        nodeSelector:
            kubernetes.io/hostname: aws1
        tolerations:
            tolerations:
                - key: nodeType.jj
                  operator: Equal
                  value: awsingress
        replicaCount: 1
        # disable as much ingress stuff as possible, only TCP NLB will be used
        ingressClassParams:
            create: false
        ingressClassConfig:
            default: false
        createIngressClassResource: false
        disableIngressClassAnnotation: true
        disableIngressGroupNameAnnotation: true
