apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: ingress-nginx
    namespace: ingress
spec:
    interval: 15m
    chart:
        spec:
            chart: ingress-nginx
            version: 4.4.2
            sourceRef:
                kind: HelmRepository
                name: ingress-nginx
                namespace: flux-system
    maxHistory: 3
    install:
        createNamespace: true
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        tcp:
            "42080": ingress/ingress-nginx-controller:20080::PROXY
            "42443": ingress/ingress-nginx-controller:20443::PROXY
        controller:
            replicaCount: 3
            # kind: DaemonSet
            extraEnvs:
                - name: TZ
                  value: Asia/Singapore
            service:
                enabled: false
                # type: LoadBalancer
                # externalIPs:
                #     - [redacted]
                # loadBalancerIP: [redacted]
                # externalTrafficPolicy: Local
                # ports:
                #     http: 80
                #     https: 443
                #     routehttp: 20080
                #     routehttps: 20443
                # targetPorts:
                #     http: internalhttp
                #     https: internalhttps
                #     routehttp: http
                #     routehttps: https
            #     nodePorts:
            #         http: 80
            #         https: 443
            containerPort:
                http: 80
                https: 443
                #     routehttp: 20080
                #     routehttps: 20443
                internalhttp: 42080
                internalhttps: 42443
            # hostNetwork: true
            # dnsPolicy: ClusterFirstWithHostNet
            publishService:
                enabled: true
            ingressClassByName: true
            ingressClassResource:
                name: internal
                enabled: true
                default: true
                controllerValue: k8s.io/ingress-nginx-internal
            nodeSelector:
                node-restriction.kubernetes.io/nodeType: main
            config:
                client-body-timeout: 10
                client-header-timeout: 10
                enable-real-ip: "true"
                use-proxy-protocol: "true"
                use-forwarded-headers: "true"
                # whitelist-source-range: 10.0.0.0/8, 100.64.0.0/10
                hsts-max-age: "31449600"
                hsts-preload: "true"
                keep-alive: 10
                disable-access-log: "false"
                log-format-escape-json: "true"
                proxy-body-size: 100K
                ssl-protocols: TLSv1.3 TLSv1.2
                hide-headers: Server,X-Powered-By
                enable-ocsp: "true"
                large-client-header-buffers: 2 1k
            # metrics:
            #   enabled: true
            #   serviceMonitor:
            #     enabled: true
            #     namespace: networking
            #     namespaceSelector:
            #       any: true
            extraArgs:
                default-ssl-certificate: ingress/short-domain-tls
            resources:
                requests:
                    cpu: 10m
                    memory: 250Mi
                limits:
                    memory: 500Mi
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1u57l4s400gqstc0p485j4646cemntufr0pcyp32yudklsp90xpmszxvnkj
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB4RzV3SGRlUzN0dExuYU5v
            eGI2NHp5RkV6cFRkQlF1MWc2NmVHQlFuNUNFCjJ5YnlzQW1PY2x6M2pyeU9QUFRI
            QnNzcGRlZmxKYWVzNDE2MjUxN3FhZmcKLS0tIGtTa29GcHNQUk8wbDE2WmlId0hR
            Z21Hem1GM3RqZjRtc3lybjBodG5NMGcKHg5A7ztd0/lIvZJh31X6a18dcKHE+On/
            jkqZi9CfTz4FtLc6V5OXWhQQSkMUQ/MAujN6rndj1hgBT68IcEcHaQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-02-21T20:22:35Z"
    mac: ENC[AES256_GCM,data:WOdPzJjdR9gdF5Hu7mMKmE4LJ7D0/OM0/o1cQjSiqJKSfHHVNFFi3VUOFAiBeqA9d8vdo94sZeQdqLicYbaTN4sK9UzJ1m2dWj3RQfq76Np9PMdFyYMXP2iImFuuTjsOEF7PIPYdHlr2FdDEHlYHuBmuyb6mUFkhqm9nlN/yZpI=,iv:1gOlBnnrWu3TjbEpz1EorvSE0RqyuETRG2gKLF8v3g0=,tag:5cje88LRHLuv68kdUBmc1w==,type:str]
    pgp:
        - created_at: "2023-02-21T20:22:34Z"
          enc: |
            -----BEGIN PGP MESSAGE-----

            hF4DAAAAAAAAAAASAQdAnb9TpVZi7fzqeFwmuiQMUCTaGr12DLWCyqeolwTOS3sw
            g+r4Nm+G07LZqfu4ANrdaFQKMBVLB8YHBUayiKWuq9pOZtJMfpqVfLijGleCrtsf
            0lwBqHOwH7V2+AggJu/aXZmbnqaNJsWHwUoFwIxt3V5kBBBASmd1HiLalTpL0Kfy
            TeVs6+0DMw32oLFbl4tmAOfulCclZaYbmDP2K4C7iOprRl/WwrGWGorUwjqs6w==
            =FqPu
            -----END PGP MESSAGE-----
          fp: 31E70E5BC80C58AFF5DD649921AC5A1AC6E5B7F2
    encrypted_regex: ^(data|stringData|commonName|dnsNames|externalIPs|loadBalancerIP|whitelist-source-range)$
    version: 3.7.3
---
apiVersion: v1
kind: Service
metadata:
    name: ingress-nginx-controller
    namespace: ingress
spec:
    allocateLoadBalancerNodePorts: true
    externalIPs:
        - ENC[AES256_GCM,data:sM6PDlrEhxqr3A==,iv:xwefcdwPbi9x7Lg65K1O11QRMwd0aUmY6g5sKwZlRA8=,tag:bp0tgY45qBOBzrIj9sbMJg==,type:str]
    externalTrafficPolicy: Local
    loadBalancerIP: ENC[AES256_GCM,data:cSWPOBSdAt+pSQ==,iv:SBdG8vBp+DhplwtJnzDVkw0xP7qgzvw5wWacXW9GcB4=,tag:j7DATZ8eeqQwj22qMd+qpg==,type:str]
    ports:
        - appProtocol: http
          name: http
          port: 20080
          protocol: TCP
          targetPort: 80
        - appProtocol: https
          name: https
          port: 20443
          protocol: TCP
          targetPort: 443
        - name: internalhttp
          port: 80
          protocol: TCP
          targetPort: 42080
        - name: internalhttps
          port: 443
          protocol: TCP
          targetPort: 42443
    selector:
        app.kubernetes.io/component: controller
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
    type: LoadBalancer
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1u57l4s400gqstc0p485j4646cemntufr0pcyp32yudklsp90xpmszxvnkj
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB4RzV3SGRlUzN0dExuYU5v
            eGI2NHp5RkV6cFRkQlF1MWc2NmVHQlFuNUNFCjJ5YnlzQW1PY2x6M2pyeU9QUFRI
            QnNzcGRlZmxKYWVzNDE2MjUxN3FhZmcKLS0tIGtTa29GcHNQUk8wbDE2WmlId0hR
            Z21Hem1GM3RqZjRtc3lybjBodG5NMGcKHg5A7ztd0/lIvZJh31X6a18dcKHE+On/
            jkqZi9CfTz4FtLc6V5OXWhQQSkMUQ/MAujN6rndj1hgBT68IcEcHaQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-02-21T20:22:35Z"
    mac: ENC[AES256_GCM,data:WOdPzJjdR9gdF5Hu7mMKmE4LJ7D0/OM0/o1cQjSiqJKSfHHVNFFi3VUOFAiBeqA9d8vdo94sZeQdqLicYbaTN4sK9UzJ1m2dWj3RQfq76Np9PMdFyYMXP2iImFuuTjsOEF7PIPYdHlr2FdDEHlYHuBmuyb6mUFkhqm9nlN/yZpI=,iv:1gOlBnnrWu3TjbEpz1EorvSE0RqyuETRG2gKLF8v3g0=,tag:5cje88LRHLuv68kdUBmc1w==,type:str]
    pgp:
        - created_at: "2023-02-21T20:22:34Z"
          enc: |
            -----BEGIN PGP MESSAGE-----

            hF4DAAAAAAAAAAASAQdAnb9TpVZi7fzqeFwmuiQMUCTaGr12DLWCyqeolwTOS3sw
            g+r4Nm+G07LZqfu4ANrdaFQKMBVLB8YHBUayiKWuq9pOZtJMfpqVfLijGleCrtsf
            0lwBqHOwH7V2+AggJu/aXZmbnqaNJsWHwUoFwIxt3V5kBBBASmd1HiLalTpL0Kfy
            TeVs6+0DMw32oLFbl4tmAOfulCclZaYbmDP2K4C7iOprRl/WwrGWGorUwjqs6w==
            =FqPu
            -----END PGP MESSAGE-----
          fp: 31E70E5BC80C58AFF5DD649921AC5A1AC6E5B7F2
    encrypted_regex: ^(data|stringData|commonName|dnsNames|externalIPs|loadBalancerIP|whitelist-source-range)$
    version: 3.7.3
