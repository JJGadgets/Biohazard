---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cloudflared
  namespace: cloudflare
spec:
  chart:
    spec:
      chart: app-template
      version: 1.5.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controller:
      type: daemonset
    image:
      repository: cloudflare/cloudflared
      tag: 2023.5.1
    args: ['tunnel', '--config', '/etc/cloudflared/config.yaml', '--metrics', '0.0.0.0:9090', 'run']
    service:
      main:
        ports:
          http:
            port: 9090
    persistence:
      config:
        enabled: true
        type: configMap
        name: cloudflared-config
        mountPath: /etc/cloudflared/config.yaml
        subPath: config.yaml
        readOnly: true
      credentials:
        enabled: true
        type: secret
        name: cloudflared-credentials
        mountPath: /etc/cloudflared/credentials.json
        subPath: credentials.json
        readOnly: true
    configMaps:
      config:
        enabled: true
        data:
          config.yaml: |
            tunnel: "${SECRET_CLOUDFLARE_TUNNEL_ID}"
            credentials-file: /etc/cloudflared/credentials.json
            no-autoupdate: true
            ingress:
              - hostname: "cftest.${DNS_SHORT}"
                service: hello_world
              - hostname: "social.jjgadgets.tech"
                service: https://ingress-nginx-controller.ingress.svc.cluster.local:443
                originRequest:
                  originServerName: "social.jjgadgets.tech"
              - hostname: "${APP_DNS_HEADSCALE}"
                service: https://headscale.headscale.svc.cluster.local.:8080
                originRequest:
                  originServerName: "${APP_DNS_HEADSCALE}"
              - hostname: "*.${DNS_SHORT}"
                service: https://ingress-nginx-controller.ingress.svc.cluster.local:443
                originRequest:
                  originServerName: "ingress.${DNS_SHORT}"
              - hostname: "*.${DNS_MAIN}"
                service: https://ingress-nginx-controller.ingress.svc.cluster.local:443
                originRequest:
                  originServerName: "ingress.${DNS_MAIN}"
              - service: http_status:200
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    external-dns.alpha.kubernetes.io/hostname: ${DNS_SHORT_CF}
    external-dns.alpha.kubernetes.io/target: ${SECRET_CLOUDFLARE_TUNNEL_ID}.cfargotunnel.com
    external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
  name: cloudflared-external-dns-${DNS_SHORT//./-}
  namespace: cloudflare
spec:
  type: ExternalName
  externalName: ${SECRET_CLOUDFLARE_TUNNEL_ID}.cfargotunnel.com
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    external-dns.alpha.kubernetes.io/hostname: ${DNS_MAIN_CF}
    external-dns.alpha.kubernetes.io/target: ${SECRET_CLOUDFLARE_TUNNEL_ID}.cfargotunnel.com
    external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
  name: cloudflared-external-dns-${DNS_MAIN//./-}
  namespace: cloudflare
spec:
  type: ExternalName
  externalName: ${SECRET_CLOUDFLARE_TUNNEL_ID}.cfargotunnel.com
