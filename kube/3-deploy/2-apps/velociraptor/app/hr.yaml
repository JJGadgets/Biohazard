---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app velociraptor
  namespace: *app
spec:
  chart:
    spec:
      chart: app-template
      version: 1.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controller:
      type: statefulset
    image:
      repository: docker.io/wlambert/velociraptor
      tag: latest@sha256:71dcf2a9dba820c3e5f06b579a1533e500d13008e1b2584eccc186a1f6957e21
    env:
      TZ: "${CONFIG_TZ}"
    service:
      main:
        enabled: true
        type: LoadBalancer
        externalTrafficPolicy: Local
        annotations:
          coredns.io/hostname: "${APP_DNS_VELOCIRAPTOR}"
        ports:
          http:
            port: &http 8000
            protocol: TCP
          gui:
            port: &gui 8889
            protocol: TCP
    ingress:
      main:
        enabled: true
        primary: true
        ingressClassName: nginx
        annotations:
          external-dns.alpha.kubernetes.io/target: "${IP_EC2_INGRESS}"
        hosts:
          - host: &host "${APP_DNS_VELOCIRAPTOR}"
            paths:
              - path: /gui
                pathType: Prefix
                service:
                  port: *gui
              - path: /
                pathType: Prefix
                service:
                  port: *http
        tls:
          - hosts:
              - *host
#     dnsConfig:
#       options:
#         - name: ndots
#           value: "1"
    podSecurityContext:
      runAsUser: &uid ${APP_UID_VELOCIRAPTOR}
      runAsGroup: *uid
      fsGroup: *uid
      fsGroupChangePolicy: Always
    volumeClaimTemplates:
      - name: persist
        mountPath: /persist
        accessMode: ReadWriteOnce
        size: 50Gi
        storageClass: block
    persistence:
      config:
        enabled: true
        type: configMap
        name: velociraptor-config
        subPath: server.config.yaml
        mountPath: /velociraptor/server.config.yaml
        readOnly: true
    configMaps:
      config:
        enabled: true
        data:
          server.config.yaml: |-
            version:
              name: velociraptor
              version: 0.6.8-2
              commit: 02edb7d
              build_time: "2023-03-27T02:28:58Z"
              install_time: 1683495915
              ci_build_url: https://github.com/Velocidex/velociraptor/actions/runs/4528050753
              compiler: go1.20.2
            Client:
              server_urls:
              - https://${APP_DNS_VELOCIRAPTOR}/
              ca_certificate: |
                ${SECRET_VELOCIRAPTOR_PKI_CA_CERT}
              nonce: ${SECRET_VELOCIRAPTOR_NONCE_CLIENT}
              writeback_darwin: /etc/velociraptor.writeback.yaml
              writeback_linux: /etc/velociraptor.writeback.yaml
              writeback_windows: $ProgramFiles\Velociraptor\velociraptor.writeback.yaml
              tempdir_windows: $ProgramFiles\Velociraptor\Tools
              max_poll: 60
              nanny_max_connection_delay: 600
              windows_installer:
                service_name: Velociraptor (${APP_DNS_VELOCIRAPTOR})
                install_path: $ProgramFiles\Velociraptor\Velociraptor.exe
                service_description: Velociraptor service (${APP_DNS_VELOCIRAPTOR})
              darwin_installer:
                service_name: com.velocidex.velociraptor
                install_path: /usr/local/sbin/velociraptor
              version:
                name: velociraptor
                version: 0.6.8-2
                commit: 02edb7d
                build_time: "2023-03-27T02:28:58Z"
                install_time: 1683495915
                ci_build_url: https://github.com/Velocidex/velociraptor/actions/runs/4528050753
                compiler: go1.20.2
              pinned_server_name: ${APP_DNS_VELOCIRAPTOR}
              max_upload_size: 5242880
              local_buffer:
                memory_size: 52428800
                disk_size: 1073741824
                filename_linux: /var/tmp/Velociraptor_Buffer.bin
                filename_windows: $TEMP/Velociraptor_Buffer.bin
                filename_darwin: /var/tmp/Velociraptor_Buffer.bin
            API:
              hostname: ${APP_DNS_VELOCIRAPTOR}
              bind_address: 127.0.0.1
              bind_port: 8001
              bind_scheme: tcp
              pinned_gw_name: GRPC_GW
            GUI:
              bind_address: 0.0.0.0
              bind_port: 8889
              base_path: /gui
              use_plain_http: true
              gw_certificate: |
                ${SECRET_VELOCIRAPTOR_PKI_GUI_GW_CERT}
              gw_private_key: |
                ${SECRET_VELOCIRAPTOR_PKI_GUI_GW_KEY}
              public_url: https://${APP_DNS_VELOCIRAPTOR}/
              links:
              - text: Documentation
                url: https://docs.velociraptor.app/
                icon_url: data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MyIgaGVpZ2h0PSI2MyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNTMgNjMiPjxwYXRoIGQ9Ik0yNyAzYy0zIDItMTMgOC0yMyAxMGw2IDMyYTEwMyAxMDMgMCAwIDAgMTcgMTZsNi01IDExLTExIDYtMzJDMzkgMTEgMzAgNSAyNyAzeiIgZmlsbD0iI2ZmZiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PHBhdGggZD0iTTI2IDBDMjMgMiAxMiA4IDAgMTBjMSA3IDUgMzIgNyAzNWExMTMgMTEzIDAgMCAwIDE5IDE4bDctNiAxMi0xMmMyLTMgNi0yOCA4LTM1QzQwIDggMjkgMiAyNiAwWm0wIDU1LTYtNC04LTktNS0yNnYtMWwyLTFjOC0xIDE2LTYgMTYtNmwxLTEgMSAxczggNSAxNyA2bDEgMXYxcy0zIDIzLTUgMjZsLTggOWMtMiAyLTQgNC02IDR6IiBmaWxsPSIjYWIwMDAwIiBmaWxsLW9wYWNpdHk9IjEiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjxwYXRoIGQ9Ik0zOSAxOWExMzQ3IDEzNDcgMCAwIDEtMTMgMjZoLTJMMTQgMTloM2wyIDEgMSAxdjFhMjUwIDI1MCAwIDAgMSA2IDE3IDUyODkgNTI4OSAwIDAgMCA5LTIwaDR6IiBmaWxsPSIjMDAwIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWRhc2hhcnJheT0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiIHN0cm9rZS13aWR0aD0iMSIvPjwvc3ZnPg==
                type: sidebar
                new_tab: true
              initial_users:
              - name: ${SECRET_VELOCIRAPTOR_OIDC_INIT_USER}
              authenticator:
                type: OIDC
                oidc_issuer: ${SECRET_VELOCIRAPTOR_OIDC_URL}
                oauth_client_id: ${SECRET_VELOCIRAPTOR_OIDC_ID}
                oauth_client_secret: ${SECRET_VELOCIRAPTOR_OIDC_SECRET}
            CA:
              private_key: |
                ${SECRET_VELOCIRAPTOR_PKI_CA_KEY}
            Frontend:
              hostname: ${APP_DNS_VELOCIRAPTOR}
              bind_address: 0.0.0.0
              bind_port: 8000
              certificate: |
                ${SECRET_VELOCIRAPTOR_PKI_FRONTEND_CERT}
              private_key: |
                ${SECRET_VELOCIRAPTOR_PKI_FRONTEND_KEY}
              use_plain_http: true
              #tls_certificate_filename: /cert/tls.crt
              #tls_private_key_filename: /cert/tls.key
              dyn_dns: {}
              default_client_monitoring_artifacts:
              - Generic.Client.Stats
              GRPC_pool_max_size: 100
              GRPC_pool_max_wait: 60
              resources:
                connections_per_second: 100
                notifications_per_second: 30
                max_upload_size: 10485760
                expected_clients: 30000
            Datastore:
              implementation: FileBaseDataStore
              location: /persist
              filestore_directory: /persist
            Logging:
              output_directory: /persist/logs
              separate_logs_per_component: true
              debug:
                disabled: true
              info:
                rotation_time: 604800
                max_age: 31536000
              error:
                rotation_time: 604800
                max_age: 31536000
            autocert_cert_cache: /persist
            Monitoring:
              bind_address: 127.0.0.1
              bind_port: 8003
            api_config: {}
            server_type: linux
            obfuscation_nonce: ${SECRET_VELOCIRAPTOR_NONCE_OBFUSCATION}
            defaults:
              hunt_expiry_hours: 168
              notebook_cell_timeout_min: 10
    resources:
      requests:
        cpu: 10m
        memory: 128Mi
      limits:
        memory: 6000Mi
