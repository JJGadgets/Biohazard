---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authentik-outpost-remote
  namespace: authentik
spec:
  chart:
    spec:
      chart: app-template
      version: 1.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    image:
      repository: ghcr.io/goauthentik/proxy
      tag: 2022.12.2@sha256:719e4a05d79ed573eb681aa90fb3bdf90b0721a538633744eceba09c8bb9fca6
    env:
      TZ: "${CONFIG_TZ}"
      AUTHENTIK_INSECURE: "false"
      AUTHENTIK_HOST: "${CONFIG_AUTHENTIK_REMOTE_HOST}"
      AUTHENTIK_TOKEN: "${SECRET_AUTHENTIK_REMOTE_TOKEN}"
      AUTHENTIK_HOST_BROWSER: "${APP_DNS_AUTHENTIK}"
    service:
      main:
        enabled: true
        primary: true
        type: ClusterIP
        ports:
          http:
            enabled: true
            primary: true
            protocol: HTTPS
            port: 9443
          unencrypted:
            enabled: true
            primary: false
            protocol: TCP
            port: 9000
    ingress:
      main:
        enabled: true
        primary: true
        ingressClassName: nginx
        annotations:
          nginx.ingress.kubernetes.io/affinity: cookie
          # https://github.com/kubernetes/ingress-nginx/issues/6728
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          nginx.ingress.kubernetes.io/server-snippet: |
            proxy_ssl_name ${APP_DNS_AUTHENTIK};
            proxy_ssl_server_name on;
            large_client_header_buffers 4 16k;
            client_header_buffer_size 16k;
          nginx.ingress.kubernetes.io/proxy-buffer-size: 16k
          nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
          # without buffer size, will get following errors due to hardening ingress-nginx buffer sizes:
          # - HTTP/1.1: 400 Request Header Or Cookie Too Large
          # - HTTP/2: HTTP/2 stream was not closed cleanly before end of the underlying stream
        hosts:
          - host: &host "${APP_DNS_AUTHENTIK}"
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - *host
    resources:
      requests:
        cpu: 10m
        memory: 128Mi
      limits:
        memory: 6000Mi
