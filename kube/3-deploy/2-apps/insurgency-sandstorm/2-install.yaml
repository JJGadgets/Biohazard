---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: insurgency-sandstorm
  namespace: sandstorm
  labels:
    helm.flux.home.arpa/app-template: "true"
spec:
  values:
    controller:
      strategy: Recreate
      type: deployment
      replicas: 1
    fullNameOverride: insurgency-sandstorm
    image:
      repository: docker.io/andrewmhub/insurgency-sandstorm
      tag: latest # I wish this wasn't how it's tagged, but alas
    args: ["-hostname=\"${CONFIG_SANDSTORM_NAME}\"", "-Log", "-Port=27102", "-QueryPort=27131", "-MapCycle=MapCycle", "-NoEAC", "-EnableCheats", "-Mods", "-mutators=${CONFIG_SANDSTORM_MUTATORS}", "-ModDownloadTravelTo=${CONFIG_SANDSTORM_INIT_MAP}?Scenario=Scenario_${CONFIG_SANDSTORM_INIT_MAP}_${CONFIG_SANDSTORM_INIT_SCENARIO}"]
    dnsPolicy: ClusterFirstWithHostNet
    dnsConfig:
      options:
        - name: ndots
          value: "1"
      nameservers:
        - "${IP_HOME_DNS}"
    probes:
      liveness:
        enabled: false
      readiness:
        enabled: false
      startup:
        enabled: false
    service:
      main:
        enabled: true
        # type: ClusterIP
        type: LoadBalancer
        externalTrafficPolicy: Local
        loadBalancerIP: "${APP_IP_SANDSTORM}"
        externalIPs:
          - "${APP_IP_SANDSTORM}"
        annotations:
          coredns.io/hostname: "${APP_DNS_SANDSTORM}"
        ports:
          http:
            enabled: false
            primary: false
          gameudp:
            enabled: true
            port: 27102
            targetPort: 27102
            protocol: UDP
          queryudp:
            enabled: true
            port: 27131
            targetPort: 27131
            protocol: UDP
    initContainers:
      init-permission:
        image: busybox:1.36.0
        imagePullPolicy: IfNotPresent
        command:
          - sh
          - -c
          - chown -R 1000:1000 /home/steam/steamcmd/sandstorm/Insurgency
          - chmod -R 775 /home/steam/steamcmd/sandstorm/Insurgency
        securityContext:
          runAsUser: 0
        volumeMounts:
          - name: mods
            mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Mods
          - name: config1
            mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/Config
          - name: config2
            mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Config
          - name: saveGames
            mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/SaveGames
    podSecurityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch
    persistence:
      mods:
        enabled: true
        type: pvc
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Mods
        accessMode: ReadWriteOnce
        storageClass: block
        size: 100Gi
        retain: true
        readOnly: false
      config1:
        enabled: true
        type: pvc
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/Config
        accessMode: ReadWriteOnce
        storageClass: block
        size: 1Gi
        retain: true
        readOnly: false
      config2:
        enabled: true
        type: pvc
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Config
        accessMode: ReadWriteOnce
        storageClass: block
        size: 1Gi
        retain: true
        readOnly: false
      saveGames:
        enabled: true
        type: pvc
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/SaveGames
        accessMode: ReadWriteOnce
        storageClass: block
        size: 10Gi
        retain: true
        readOnly: false
      gameini:
        enabled: true
        type: configMap
        name: insurgency-sandstorm-gameini
        subPath: Game.ini
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/Config/LinuxServer/Game.ini
        defaultMode: 0777
        readOnly: true
      engineini:
        enabled: true
        type: configMap
        name: insurgency-sandstorm-engineini
        subPath: Engine.ini
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/Config/LinuxServer/Engine.ini
        defaultMode: 0777
        readOnly: true
      gameusersettingsini:
        enabled: true
        type: secret
        name: insurgency-sandstorm-gameusersettingsini
        subPath: GameUserSettings.ini
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Saved/Config/LinuxServer/GameUserSettings.ini
        defaultMode: 0777
        readOnly: true
      adminstxt:
        enabled: true
        type: secret
        name: insurgency-sandstorm-adminstxt
        subPath: Admins.txt
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Config/Server/Admins.txt
        defaultMode: 0777
        readOnly: true
      mapcycletxt:
        enabled: true
        type: configMap
        name: insurgency-sandstorm-mapcycletxt
        subPath: MapCycle.txt
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Config/Server/MapCycle.txt
        defaultMode: 0777
        readOnly: true
      modstxt:
        enabled: true
        type: configMap
        name: insurgency-sandstorm-modstxt
        subPath: Mods.txt
        mountPath: /home/steam/steamcmd/sandstorm/Insurgency/Config/Server/Mods.txt
        defaultMode: 0777
        readOnly: true
    resources:
      requests:
        memory: 1024Mi
